// TRTH Employee Assessment System - Prisma Schema
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Employee Model
// ============================================
model Employee {
  id              String   @id @default(cuid())
  empCode         String   @unique
  empName_Eng     String
  empName_Thai    String?
  email           String?
  phoneNumber     String?
  profileImage    String?  // URL or path to profile image
  position        String
  group           String   // e.g., "PRD,QA"
  team            String?
  assessmentLevel String   // L1-Supplier, L2-Operator, L3-General, L4-Supervise, L5-Interpreter, L6-Management
  employeeType    String   // Permanent, Temporary
  approver1_ID    String?  // Approver 1
  approver2_ID    String?  // Approver 2
  approver3_ID    String?  // Approver 3
  manager_ID      String?  // Manager (Applied by Manager)
  gm_ID           String?  // GM (Confirmed by GM)
  joinDate        DateTime
  warningCount    Int      @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  assessments        Assessment[] @relation("EmployeeAssessments")
  createdAssessments Assessment[] @relation("AssessmentCreator")
  user               User?
  
  @@index([empCode])
  @@index([group])
  @@index([assessmentLevel])
  @@index([isActive])
  @@map("employees")
}

// ============================================
// Assessment Question Model
// ============================================
model AssessmentQuestion {
  id              String   @id @default(cuid())
  questionTitle   String
  description     String?
  category        String   // Technical, Leadership, Communication, etc.
  weight          Float    // Percentage weight in assessment
  maxScore        Float    @default(5)
  order           Int      // Display order
  isActive        Boolean  @default(true)
  applicableLevel String   // L1-Supplier, L2-Operator, L3-General, L4-Supervise, L5-Interpreter, L6-Management, All
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  responses       AssessmentResponse[]

  @@index([applicableLevel])
  @@index([category])
  @@index([isActive])
  @@index([order])
  @@index([isActive, applicableLevel, category, order]) // Composite index for template loading
  @@map("assessment_questions")
}

// ============================================
// Assessment Model
// ============================================
model Assessment {
  id              String   @id @default(cuid())
  title           String?
  description     String?
  assessmentType  String   // Annual, Probation, Mid-Year, etc.
  status          String   // Draft, Assigned, InProgress, PendingApprover1, PendingApprover2, PendingApprover3, PendingManager, PendingMD, Completed, Rejected
  employeeId      String   // Foreign key to Employee.empCode
  assessorId      String?  // Who created the assessment (Admin)
  targetLevel     String?  // L1-L6 (which level this assessment is for)
  isDraft         Boolean  @default(true)
  currentStage    String?  // Who is it waiting for? (empCode)
  rejectionStage  String?  // If rejected, from which stage?
  rejectionReason String?  @db.Text
  
  // Dates
  periodStart     DateTime
  periodEnd       DateTime
  dueDate         DateTime
  assignedAt      DateTime?
  submittedAt     DateTime?
  approvedAt      DateTime?
  completedAt     DateTime?
  
  // Approval Tracking
  approver1Status String?  // Pending, Approved, Rejected
  approver1Date   DateTime?
  approver1Note   String?  @db.Text
  
  approver2Status String?  // Pending, Approved, Rejected
  approver2Date   DateTime?
  approver2Note   String?  @db.Text
  
  approver3Status String?  // Pending, Approved, Rejected
  approver3Date   DateTime?
  approver3Note   String?  @db.Text
  
  managerStatus   String?  // Pending, Approved, Rejected
  managerDate     DateTime?
  managerNote     String?  @db.Text
  
  mdStatus        String?  // Pending, Approved, Rejected
  mdDate          DateTime?
  mdNote          String?  @db.Text
  
  // Scores
  score           Float?   // Current/interim score
  finalScore      Float?   // Final approved score
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  employee        Employee @relation("EmployeeAssessments", fields: [employeeId], references: [empCode], onDelete: Cascade)
  assessor        Employee? @relation("AssessmentCreator", fields: [assessorId], references: [empCode])
  responses       AssessmentResponse[]

  @@index([employeeId])
  @@index([status])
  @@index([dueDate])
  @@index([assessmentType])
  @@map("assessments")
}

// ============================================
// Assessment Response Model
// ============================================
model AssessmentResponse {
  id              String   @id @default(cuid())
  assessmentId    String
  questionId      String
  questionTitle   String
  questionWeight  Float
  
  // Scores from different roles (0-5 scale)
  scoreSelf       Float?
  scoreAppr1      Float?   // Approver 1 score
  scoreAppr2      Float?   // Approver 2 score
  scoreAppr3      Float?   // Approver 3 score
  scoreMgr        Float?   // Manager score (Applied by Manager)
  scoreGm         Float?   // GM score (Confirmed by GM)
  
  // Comments from different roles
  commentSelf     String?  @db.Text
  commentAppr1    String?  @db.Text
  commentAppr2    String?  @db.Text
  commentAppr3    String?  @db.Text
  commentMgr      String?  @db.Text
  commentGm       String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  assessment      Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  question        AssessmentQuestion @relation(fields: [questionId], references: [id])

  @@unique([assessmentId, questionId])
  @@index([assessmentId])
  @@index([questionId])
  @@map("assessment_responses")
}

// ============================================
// User Model (for Authentication)
// ============================================
model User {
  id            String    @id @default(cuid())
  empCode       String?   @unique // Optional for system admin
  email         String    @unique
  name          String
  role          String    @default("EMPLOYEE") // ADMIN, MANAGER, EMPLOYEE
  userType      String    @default("EMPLOYEE") // SYSTEM_ADMIN, EMPLOYEE
  passwordHash  String
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  employee      Employee? @relation(fields: [empCode], references: [empCode])

  @@index([email])
  @@index([empCode])
  @@index([role])
  @@map("users")
}

// ============================================
// Delegation Model (Temporary Access Rights)
// ============================================
model Delegation {
  id              String   @id @default(cuid())
  delegatorId     String   // Admin who grants permission (empCode)
  delegateeId     String   // Employee who receives permission (empCode)
  permission      String   // MANAGE_EMPLOYEES, MANAGE_ASSESSMENTS, VIEW_REPORTS, etc.
  startDate       DateTime
  endDate         DateTime
  reason          String?  @db.Text
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  revokedAt       DateTime?
  revokedBy       String?

  @@index([delegateeId])
  @@index([permission])
  @@index([isActive])
  @@index([endDate])
  @@map("delegations")
}

// ============================================
// Audit Log Model
// ============================================
model AuditLog {
  id          String   @id @default(cuid())
  userId      String
  userEmail   String
  action      String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, APPROVE, REJECT, etc.
  entity      String   // Assessment, Employee, Question, Response, etc.
  entityId    String
  changes     Json?    // Store before/after values
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([entity])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// Master Data Models
// ============================================
model Position {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
  @@index([sortOrder])
  @@map("positions")
}

model Group {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
  @@index([sortOrder])
  @@map("groups")
}

model Team {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  groupCode   String?  // Link to Group
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
  @@index([groupCode])
  @@index([sortOrder])
  @@map("teams")
}

model AssessmentType {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
  @@index([sortOrder])
  @@map("assessment_types")
}

model AssessmentLevel {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., L1-Supplier
  name        String   // e.g., Supplier
  description String?  // e.g., ผู้จัดหา/ซัพพลายเออร์
  label       String   // e.g., L1-Supplier - Supplier (ผู้จัดหา/ซัพพลายเออร์)
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
  @@index([sortOrder])
  @@index([isActive])
  @@map("assessment_levels")
}

// ============================================
// Notification Model
// ============================================
model Notification {
  id           String   @id @default(cuid())
  userId       String   // Employee.empCode who receives notification
  type         String   // AssessmentAssigned, ApprovalRequired, Rejected, Approved, Completed
  title        String
  message      String   @db.Text
  assessmentId String?  // Related assessment if applicable
  link         String?  // URL to navigate to
  isRead       Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}
